{% from "govuk/components/back-link/macro.njk" import govukBackLink %}
{%- from "moj/components/alert/macro.njk" import mojAlert -%}
{% extends "../layout.njk" %}
{% set section = "cases" %}

{% set name = [case.firstName, ' ', case.lastName] | join %}

{% macro changeButton(status, link, hiddenText) %}
  {% if status != "INACTIVE" %}
    <a href="{{ link }}" class="govuk-link govuk-link--no-visited-state"
      >Change<span class="govuk-visually-hidden"> {{ hiddenText }}</span></a
    >
  {% endif %}
{% endmacro %}

{% block beforeContent %}
  <div class="es-page-actions">
    <div class="es-page-actions__back">
      {{
        govukBackLink({
          text: "Back",
          href: "/practitioners/cases/stopped" if case.status == "INACTIVE" else "/practitioners/cases"
        })
      }}
    </div>
    <div class="es-page-actions__actions">
      {% if flags.debugMode == true and case.status == "VERIFIED" %}
        <a href="{{ offenderId }}/invite" class="govuk-button govuk-button--secondary es-debug">Invite</a>
      {% endif %}
      {% if case.status != "INACTIVE" %}
        <a href="/practitioners/cases/{{ offenderId }}/update/stop-checkins" class="govuk-button govuk-button--warning"
          >Stop check ins</a
        >
      {% endif %}
    </div>
  </div>
{% endblock %}

{% block content %}

  {% if successMessage %}
    {{
      mojAlert({
        variant: "success",
        title: successMessage.title,
        showTitleAsHeading: true,
        dismissible: false,
        html: successMessage.message
      })
    }}
  {% endif %}

  {% if case.status == "INACTIVE" %}
    {{
      mojAlert({
        variant: "info",
        title: 'Check-ins stopped',
        showTitleAsHeading: true,
        dismissible: false
      })
    }}
  {% endif %}

  <div class="es-page-header">
    <h1 class="govuk-heading-l">
      <span class="govuk-caption-l">Manage check ins</span> <span class="govuk-visually-hidden">for</span>
      {{ case.firstName }} {{ case.lastName }} ({{ case.dateOfBirth | gdsDate }})
    </h1>
  </div>
  <div class="es-flex-row">
    <h2 class="govuk-heading-m">Personal details</h2>
    <p>
      {{ changeButton(case.status, "/practitioners/cases/" + offenderId + "/update/personal-details", "the personal details for " + name) }}
    </p>
  </div>

  <dl class="govuk-summary-list">
    <div class="govuk-summary-list__row">
      <dt class="govuk-summary-list__key">First name</dt>
      <dd class="govuk-summary-list__value">{{ case.firstName }}</dd>
    </div>
    <div class="govuk-summary-list__row">
      <dt class="govuk-summary-list__key">Last name</dt>
      <dd class="govuk-summary-list__value">{{ case.lastName }}</dd>
    </div>
    <div class="govuk-summary-list__row">
      <dt class="govuk-summary-list__key">Date of birth</dt>
      <dd class="govuk-summary-list__value">{{ case.dateOfBirth | gdsDate }}</dd>
    </div>
    <div class="govuk-summary-list__row">
      <dt class="govuk-summary-list__key">Case reference number (CRN)</dt>
      <dd class="govuk-summary-list__value">{{ case.crn }}</dd>
    </div>
    <div class="govuk-summary-list__row govuk-visually-hidden">
      <dt class="govuk-summary-list__key">Status</dt>
      <dd class="govuk-summary-list__value">{{ case.status }}</dd>
    </div>
  </dl>

  {# Only show photo and contact details if they are active #}
  {% if case.status != "INACTIVE" %}
    <div class="es-flex-row">
      <h2 class="govuk-heading-m">Photo</h2>
    </div>
    <dl class="govuk-summary-list">
      <div class="govuk-summary-list__row">
        <dt class="govuk-summary-list__key">Photo on file</dt>
        <dd class="govuk-summary-list__value">
          <img
            src="{{ "/assets/images/placeholder.png" if case.photoUrl == null else case.photoUrl }}"
            class="es-profile-image es-profile-image--small"
            alt="Profile image of {{ name }}"
          />
        </dd>
      </div>
    </dl>
    {% set contactPreference = "text" if case.phoneNumber else "email" %}
    <div class="es-flex-row">
      <h2 class="govuk-heading-m">Contact details</h2>
      <p>
        {{ changeButton(case.status, "/practitioners/cases/" + offenderId + "/update/contact-details", "the contact details for " + name) }}
      </p>
    </div>
    <dl class="govuk-summary-list">
      <div class="govuk-summary-list__row">
        <dt class="govuk-summary-list__key">How does {{ name }} want us to send a link?</dt>
        <dd class="govuk-summary-list__value">
          {% if contactPreference == "text" %}
            Text message
          {% else %}
            Email
          {% endif %}
        </dd>
      </div>
      {% if contactPreference == "text" %}
        <div class="govuk-summary-list__row">
          <dt class="govuk-summary-list__key">Mobile number</dt>
          <dd class="govuk-summary-list__value">{{ case.phoneNumber }}</dd>
        </div>
      {% else %}
        <div class="govuk-summary-list__row">
          <dt class="govuk-summary-list__key">Email address</dt>
          <dd class="govuk-summary-list__value">{{ case.email }}</dd>
        </div>
      {% endif %}
    </dl>
  {% endif %}

  <div class="es-flex-row">
    <h2 class="govuk-heading-m">Check in settings</h2>
    <p>
      {{ changeButton(case.status, "/practitioners/cases/" + offenderId + "/update/checkin-settings", "the check in settings for " + name) }}
    </p>
  </div>

  <dl class="govuk-summary-list">
    <div class="govuk-summary-list__row">
      <dt class="govuk-summary-list__key">Next check in</dt>
      <dd class="govuk-summary-list__value">
        {% if case.status == "INACTIVE" %}
          Check ins stopped
        {% else %}
        {{ nextCheckinDate | gdsDate }}
        {% endif %}
      </dd>
    </div>
    <div class="govuk-summary-list__row">
      <dt class="govuk-summary-list__key">Frequency</dt>
      <dd class="govuk-summary-list__value">{{ case.checkinInterval | userFriendlyString }}</dd>
    </div>
  </dl>
{% endblock %}
